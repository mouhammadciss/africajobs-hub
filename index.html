<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AfricaJobs Hub AI</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
.animate-spin { animation: spin 1s linear infinite; }
</style>
</head>

<body class="bg-gradient-to-br from-orange-50 via-yellow-50 to-green-50">
<div id="app"></div>

<script>
/* =======================
   CONFIG & Ã‰TAT GLOBAL
======================= */
const countries = ["SÃ©nÃ©gal","CÃ´te d'Ivoire","Kenya","Nigeria","Maroc","Ghana"];
const jobTypes = ["Marketing Digital","Communication","Digital/Tech","Marketing"];

let state = {
  jobs: [],
  loading: false,
  aiStatus: "idle",
  searchQuery: "",
  selectedCountry: "all",
  selectedType: "all",
  showFilters: false,
  lastUpdate: null,
  selectedJob: null
};

/* =======================
   DONNÃ‰ES DÃ‰MO (fallback)
======================= */
function loadDemoJobs() {
  state.jobs = [
    {
      id: crypto.randomUUID(),
      title: "Chef de Projet Marketing Digital",
      company: "Orange SÃ©nÃ©gal",
      country: "SÃ©nÃ©gal",
      city: "Dakar",
      type: "Marketing Digital",
      salary: "Ã€ nÃ©gocier",
      tags: ["SEO","Analytics","Ads"],
      date: new Date().toISOString(),
      source: "emploi.sn",
      url: "#"
    },
    {
      id: crypto.randomUUID(),
      title: "Social Media Manager",
      company: "Jumia",
      country: "Kenya",
      city: "Nairobi",
      type: "Marketing Digital",
      salary: "KES 150,000",
      tags: ["Content","Community","Meta Ads"],
      date: new Date().toISOString(),
      source: "brightermonday.co.ke",
      url: "#"
    }
  ];
}

/* =======================
   API LIVE (BACKEND)
======================= */
async function searchJobsWithAI() {
  state.loading = true;
  state.aiStatus = "ðŸ” Recherche d'offres en cours...";
  render();

  try {
    const res = await fetch("/api/jobs");
    if (!res.ok) throw new Error("API indisponible");

    const data = await res.json();
    if (Array.isArray(data.jobs)) {
      state.jobs = data.jobs.map(j => ({
        ...j,
        id: crypto.randomUUID(),
        date: new Date().toISOString()
      }));
      state.lastUpdate = new Date();
      state.aiStatus = `âœ… ${state.jobs.length} offres chargÃ©es`;
    } else {
      throw new Error("Format invalide");
    }
  } catch (e) {
    console.warn("Fallback dÃ©mo:", e.message);
    loadDemoJobs();
    state.aiStatus = "âš ï¸ Mode dÃ©mo activÃ©";
  } finally {
    state.loading = false;
    setTimeout(() => state.aiStatus = "idle", 3000);
    render();
  }
}

/* =======================
   FILTRAGE
======================= */
function filteredJobs() {
  return state.jobs.filter(j => {
    return (
      (state.selectedCountry === "all" || j.country === state.selectedCountry) &&
      (state.selectedType === "all" || j.type === state.selectedType) &&
      (
        j.title.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
        j.company.toLowerCase().includes(state.searchQuery.toLowerCase())
      )
    );
  });
}

/* =======================
   RENDER
======================= */
function render() {
const jobs = filteredJobs();

document.getElementById("app").innerHTML = `
<header class="bg-white shadow p-6">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <h1 class="text-3xl font-bold text-orange-600">AfricaJobs Hub AI</h1>
    <button id="refreshBtn"
      class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"
      ${state.loading ? "disabled" : ""}>
      <span class="${state.loading ? 'animate-spin' : ''}">ðŸ”„</span>
      Actualiser
    </button>
  </div>

  ${state.aiStatus !== "idle" ? `
    <div class="mt-3 text-sm text-blue-700">${state.aiStatus}</div>
  ` : ""}
</header>

<main class="max-w-7xl mx-auto p-6">
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <input id="searchInput"
      value="${state.searchQuery}"
      placeholder="Rechercher..."
      class="w-full border px-4 py-2 rounded" />

    <div class="mt-4 flex gap-4">
      <select id="countrySelect" class="border px-3 py-2 rounded">
        <option value="all">Tous les pays</option>
        ${countries.map(c => `<option ${c===state.selectedCountry?"selected":""}>${c}</option>`).join("")}
      </select>

      <select id="typeSelect" class="border px-3 py-2 rounded">
        <option value="all">Tous les types</option>
        ${jobTypes.map(t => `<option ${t===state.selectedType?"selected":""}>${t}</option>`).join("")}
      </select>
    </div>
  </div>

  ${jobs.length === 0 ? `
    <div class="bg-white p-12 text-center rounded shadow">
      Aucune offre disponible
    </div>
  ` : `
    <div class="space-y-4">
      ${jobs.map(j => `
        <div class="bg-white p-6 rounded shadow">
          <div class="flex justify-between">
            <div>
              <h3 class="text-xl font-bold">${j.title}</h3>
              <p class="text-orange-600">${j.company}</p>
              <p class="text-sm text-gray-600">${j.city}, ${j.country}</p>
            </div>
            <button data-id="${j.id}"
              class="bg-orange-600 text-white px-4 py-2 rounded">
              Voir l'offre
            </button>
          </div>
        </div>
      `).join("")}
    </div>
  `}
</main>

${state.selectedJob ? `
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white max-w-lg w-full p-6 rounded relative">
    <button onclick="state.selectedJob=null;render()"
      class="absolute top-3 right-3">âœ•</button>

    <h2 class="text-2xl font-bold mb-2">${state.selectedJob.title}</h2>
    <p class="text-orange-600 mb-2">${state.selectedJob.company}</p>
    <p class="text-sm mb-4">${state.selectedJob.city}, ${state.selectedJob.country}</p>

    <p class="font-medium mb-3">ðŸ’° ${state.selectedJob.salary}</p>

    <div class="flex gap-2 flex-wrap mb-4">
      ${state.selectedJob.tags.map(t => `
        <span class="bg-gray-100 px-2 py-1 text-xs rounded">${t}</span>
      `).join("")}
    </div>

    <a href="${state.selectedJob.url}" target="_blank"
      class="block bg-green-600 text-white text-center py-3 rounded">
      Postuler
    </a>
  </div>
</div>
` : ""}
`;
attachEvents();
}

/* =======================
   EVENTS
======================= */
function attachEvents() {
document.getElementById("refreshBtn")?.addEventListener("click", searchJobsWithAI);

document.getElementById("searchInput")?.addEventListener("input", e => {
  state.searchQuery = e.target.value;
  render();
});

document.getElementById("countrySelect")?.addEventListener("change", e => {
  state.selectedCountry = e.target.value;
  render();
});

document.getElementById("typeSelect")?.addEventListener("change", e => {
  state.selectedType = e.target.value;
  render();
});

document.querySelectorAll("[data-id]").forEach(btn => {
  btn.addEventListener("click", () => {
    state.selectedJob = state.jobs.find(j => j.id === btn.dataset.id);
    render();
  });
});
}

/* =======================
   INIT
======================= */
loadDemoJobs();
render();
</script>
</body>
</html>
